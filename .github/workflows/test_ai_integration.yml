name: Test AI Integration Workflow

on:
  workflow_dispatch:
    inputs:
      openai_key_check:
        description: 'Test with OpenAI key check (true/false)'
        required: true
        default: false
        type: boolean
      mock_content:
        description: 'Content to mock-generate with AI'
        required: false
        default: 'Sample documentation content'

jobs:
  test_ai_plugin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout: |
            docs
            includes
            mkdocs_plugins

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest

      - name: Lint AI plugin
        run: |
          echo "ğŸ” Linting AI plugin..."
          flake8 mkdocs_plugins/ai_plugin.py --count --select=E9,F63,F7,F82 --show-source --statistics
          echo "âœ… Linting completed"

      - name: Create mock environment
        run: |
          echo "ğŸ”§ Setting up mock environment..."
          if [ "${{ github.event.inputs.openai_key_check }}" = "true" ]; then
            echo "OPENAI_API_KEY=sk-mock-key-for-testing-only" >> $GITHUB_ENV
            echo "âœ… Mock API key configured for testing"
          else
            echo "âš ï¸ Running without API key (testing fallback behavior)"
          fi

      - name: Prepare test content
        run: |
          echo "ğŸ“ Preparing test content..."
          mkdir -p .test_output
          echo "${{ github.event.inputs.mock_content }}" > .test_output/mock_content.txt
          echo "âœ… Test content ready"

      - name: Test build with AI plugin
        run: |
          echo "ğŸ—ï¸ Building with AI plugin..."
          mkdocs build --strict
          echo "âœ… Build completed successfully"
          
      - name: Verify AI demo page
        run: |
          echo "ğŸ” Verifying AI demo page exists..."
          if [ -f "./site/ai-demo/index.html" ]; then
            echo "âœ… AI demo page successfully built"
          else
            echo "âŒ AI demo page not found in build!"
            exit 1
          fi

      - name: Test AI plugin functionality (dry run)
        run: |
          echo "ğŸ¤– Testing AI plugin functionality (simulation)..."
          echo "Input content: ${{ github.event.inputs.mock_content }}"
          echo "Generated summary would appear here in actual implementation"
          echo "âœ… AI plugin functionality test completed"
          
      - name: Print summary
        run: |
          echo "ğŸ“Š Test Summary"
          echo "==============="
          echo "âœ… AI Plugin loads correctly"
          echo "âœ… AI Demo page builds successfully"
          if [ "${{ github.event.inputs.openai_key_check }}" = "true" ]; then
            echo "âœ… API key detection works"
          else
            echo "âœ… Fallback behavior works when no API key is present"
          fi
          echo ""
          echo "ğŸ” In a real scenario:"
          echo "1. The AI plugin would connect to the OpenAI API"
          echo "2. Content would be generated based on the user's prompt"
          echo "3. Generated content would be inserted into the documentation"